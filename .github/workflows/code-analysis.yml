name: "ðŸ” AnÃ¡lisis EstÃ¡tico de CÃ³digo .NET"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  codeql-analysis:
    name: "CodeQL - AnÃ¡lisis de Seguridad C#"
    runs-on: windows-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: "ðŸ“¥ Checkout del cÃ³digo"
      uses: actions/checkout@v4
      
    - name: "ðŸ› ï¸ Setup .NET"
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: | 
          8.x
          7.x
          6.x
          
    - name: "ðŸ› ï¸ Inicializar CodeQL"
      uses: github/codeql-action/init@v3
      with:
        languages: 'csharp'
        queries: security-extended,security-and-quality
        build-mode: manual
        
    - name: "ðŸ—ï¸ Restaurar y Compilar"
      shell: pwsh
      run: |
        $sln = Get-ChildItem -Recurse -Filter *.sln | Select-Object -First 1
        if ($sln) {
          Write-Host "Usando soluciÃ³n $($sln.FullName)"
          dotnet restore $sln.FullName
          dotnet build $sln.FullName --configuration Release
        } else {
          $proj = Get-ChildItem -Recurse -Filter *.csproj | Select-Object -First 1
          if ($proj) {
            Write-Host "Usando proyecto $($proj.FullName)"
            dotnet restore $proj.FullName
            dotnet build $proj.FullName --configuration Release
          } else {
            Write-Error "âŒ No se encontrÃ³ ni .sln ni .csproj en el repo."
            exit 1
          }
        }

    - name: "ðŸ”¬ Ejecutar AnÃ¡lisis CodeQL"
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:csharp"

  security-scan-dotnet:
    name: "Security Code Scan - AnÃ¡lisis C#"
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'
    - name: "ðŸ›¡ï¸ Ejecutar Security Code Scan"
      shell: pwsh
      run: |
        $projs = Get-ChildItem -Recurse -Filter *.csproj
        if ($projs) {
          foreach ($p in $projs) {
            Write-Host "Analizando $($p.FullName)"
            dotnet build $p.FullName --configuration Release /p:SecurityCodeScanEnabled=true
          }
        } else {
          Write-Warning "No se encontraron proyectos .csproj"
        }

  roslyn-analyzers:
    name: "Analizadores Roslyn - Calidad CÃ³digo"
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'
    - name: "ðŸ”§ Ejecutar Analizadores Roslyn"
      run: dotnet build --configuration Release --verbosity normal /warnaserror
    - name: "ðŸ“ Ejecutar AnÃ¡lisis de CÃ³digo"
      run: dotnet format --verify-no-changes --severity info
    - name: "ðŸ’¾ Guardar Reporte de AnÃ¡lisis"
      uses: actions/upload-artifact@v4
      with:
        name: roslyn-analysis-results
        path: bin/Release/
        retention-days: 7

  dotnet-specific-checks:
    name: "Chequeos EspecÃ­ficos .NET"
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.x'
    - name: "ðŸ”Ž Buscar Patrones Peligrosos C#"
      shell: pwsh
      run: |
        $patterns = @{
          "SqlCommand con concatenaciÃ³n" = 'SqlCommand.*\+'
          "Command Injection" = 'Process\.Start.*\+'
          "Path Injection" = 'Path\.Combine.*\+'
          "DeserializaciÃ³n insegura" = 'BinaryFormatter|SoapFormatter'
          "ContraseÃ±as hardcodeadas" = 'password.*=.*".*"'
        }
        echo "## ðŸ” Patrones de Seguridad Encontrados" >> $env:GITHUB_STEP_SUMMARY
        foreach ($pattern in $patterns.GetEnumerator()) {
          $results = Select-String -Path "*.cs" -Pattern $pattern.Value
          if ($results) {
            echo "### $($pattern.Key):" >> $env:GITHUB_STEP_SUMMARY
            foreach ($r in $results) {
              echo "- $($r.Filename):$($r.LineNumber) - $($r.Line.Trim())" >> $env:GITHUB_STEP_SUMMARY
            }
            echo "" >> $env:GITHUB_STEP_SUMMARY
          }
        }
